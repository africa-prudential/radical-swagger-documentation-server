name: staging workflow

on:
  push:
    branches:
      - test
  pull_request:
    branches:
      - test

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
#       - name: SonarQube Scan
#         uses: sijomc/sonarscan-action@1.1
#         with:
#           host: ${{ secrets.SONARQUBE_HOST }}
#           login: ${{ secrets.SONARQUBE_LOGIN }}
#           projectKey: ${{ secrets.SONAR_PROJECT_KEY }}
#           projectName: ${{ secrets.SONAR_PROJECT_KEY}}

      - name: docker login
        env:
          DOCKER_USER: ${{secrets.DOCKER_USERNAME_DEV}}
          DOCKER_PASSWORD: ${{secrets.DOCKER_PASSWORD_DEV}}
        run: |
          docker login -u $DOCKER_USER -p $DOCKER_PASSWORD easycoop.azurecr.io
      - name: Build the Docker image
        run: docker build . --file Dockerfile --tag easycoop.azurecr.io/radical-swagger-documentation-server:latest
      - name:  Docker push
        run: docker push easycoop.azurecr.io/radical-swagger-documentation-server:latest

      ####### Deploy to K8s Cluster #######
      - name: Azure Kubernetes set context
        uses: azure/k8s-set-context@v1
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.DEV_KUBE_CONFIG }}
          context: ap-dev-cluster
        id: login

        # Deploy to k8s cluster
      - name: Deploy to Kubernetes cluster
        uses: Azure/k8s-deploy@v1.4
        with:
          manifests: |
            k8s/test/deployment.yaml
            k8s/test/configmap.yaml
            k8s/test/ingress.yaml
            k8s/test/service.yaml
          images: 'easycoop.azurecr.io/radical-swagger-documentation-server:latest'
          imagepullsecrets: easycoop-dev
          namespace: easycoop
          action: deploy

      # restart pods
      - run: |
          kubectl -n easycoop rollout restart deployment radical-swagger-documentation-server
